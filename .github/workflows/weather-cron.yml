name: Auto Weather System

on:
  # 1. 24小时不间断运行 (每小时一次)
  schedule:
    - cron: '0 * * * *'
  # 2. 推送代码时触发
  push:
    branches: [ main ]
  # 3. 手动触发按钮
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-system:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 分别拉取 main（源码）和 gh-pages（历史 + 站点）
      - name: 📥 拉取 main 分支代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: main

      - name: 📥 拉取 gh-pages 分支
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: ⚙️ 准备环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 📦 安装依赖
        working-directory: main
        run: npm install

      # 第一步：跑机器人脚本 (需要微信和和风 Key)，并把历史写入 gh-pages/history
      - name: 🤖 运行气象监控
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          QWEATHER_KEY: ${{ secrets.VITE_QWEATHER_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # 关键：让 HISTORY_ROOT / DATA_FILE / LATEST_FILE 指向 gh-pages（持久化）
          HISTORY_ROOT: ${{ github.workspace }}/gh-pages/history
          DATA_FILE: ${{ github.workspace }}/gh-pages/weather-status.json
          LATEST_FILE: ${{ github.workspace }}/gh-pages/latest-briefings.json
        working-directory: main
        run: node scripts/monitor.js
      

      # 第二步：构建网页 (需要注入前端用的 VITE_ 变量！)
      - name: 🏗️ 构建网页 (Vite Build)
        env:
          # 🚨 关键！必须在这里声明，Vite 才能读到 Secrets 并打包进 dist
          VITE_QWEATHER_KEY: ${{ secrets.VITE_QWEATHER_KEY }}
          #VITE_DEEPSEEK_API_KEY: ${{ secrets.VITE_DEEPSEEK_API_KEY }}
        working-directory: main
        run: npm run build

      # 第三步：将构建后的 dist 拷贝到 gh-pages 分支（保留 history 目录）
      - name: 📂 同步 dist 到 gh-pages（保留 history 与 .git）
        run: |
          rsync -av --delete \
            --exclude '.git/' \
            --exclude 'history/' \
            --exclude 'weather-status.json' \
            --exclude 'latest-briefings.json' \
            main/dist/ gh-pages/

      # 第四步：提交并推送 gh-pages（包含最新网页和 history）
      - name: 🚀 提交并推送到 gh-pages
        working-directory: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update site & history $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push origin gh-pages
          fi
